
# Flink 内存调优

## Flink 内存模型

![内存模型](../../resources/image/FLink%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.png)

对各个部分做下说明：
1、 Framework Heap
含义描述：
Flink 框架本身占用的内存,这部分的内存一般情况下是不需要修改的,在特殊的情况下可能需要调整.

参数设置：
* taskmanager.memory.framework.heap.size：堆内部分(Framework Heap)，默认值 128M；
* taskmanager.memory.framework.off-heap.size：堆外部分(Framework Off-Heap)，以直接内存形式分配，默认值 128M。

2、 Task Heap

含义描述：
用于 Flink 应用的算子及用户代码占用的内存。

参数设置：
* taskmanager.memory.task.heap.size：堆内部分(Task Heap)，无默认值，一般不建议设置，会自动用 Flink 总内存减去框架、托管、网络三部分的内存推算得出。
* taskmanager.memory.task.off-heap.size：堆外部分(Task Off-Heap)，以直接内存形式分配，默认值为 0，即不使用。如果代码中需要调用 Native Method 并分配堆外内存，可以指定该参数。一般不使用，所以大多数时候可以保持0。

3、 Managed Memory

含义描述：纯堆外内存，由 MemoryManager 管理，用于中间结果缓存、排序、哈希表等，以及 RocksDB 状态后端。可见，RocksDB 消耗的内存可以由用户显式控制了，不再像旧版本一样难以预测和调节。

参数设置：
* taskmanager.memory.managed.fraction：托管内存占 Flink 总内存 
* taskmanager.memory.flink.size 的比例，默认值 0.4；
* taskmanager.memory.managed.size：托管内存的大小，无默认值，一般也不指定，而是依照上述比例来推定，更加灵活。

4、 Network
含义描述:
Network Memory 使用的是 Directory memory，在 Task 与 Task 之间进行数据交换时（shuffle），需要将数据缓存下来，缓存能够使用的内存大小就是这个 Network Memory。它由是三个参数决定：

相关参数设置:
* taskmanager.memory.network.min：网络缓存的最小值，默认 64MB；
* taskmanager.memory.network.max：网络缓存的最大值，默认 1GB；
* taskmanager.memory.network.fraction：网络缓存占 Flink 总内存 taskmanager.memory.flink.size 的比例，默认值 0.1。若根据此比例算出的内存量比最小值小或比最大值大，就会限制到最小值或者最大值。

5、 JVM Metaspace
含义描述:
从 JDK 8 开始，JVM 把永久代拿掉了。类的一些元数据放在叫做 Metaspace 的 Native Memory 中。在 Flink 中的 JVM Metaspace Memory 也一样，它配置的是 Task Manager JVM 的元空间内存大小。

参数设置：
* taskmanager.memory.jvm-metaspace.size：默认值 256MB。

6、VM Overhead

含义描述:
保留给 JVM 其他的内存开销。例如：Thread Stack、code cache、GC 回收空间等等。和 Network Memory 的配置方法类似。它也由三个配置决定:

参数设置:
* taskmanager.memory.jvm-overhead.min：JVM 额外开销的最小值，默认 192MB；
* taskmanager.memory.jvm-overhead.max：JVM 额外开销的最大值，默认 1GB；
* taskmanager.memory.jvm-overhead.fraction：JVM 额外开销占 TM 进程总内存
* taskmanager.memory.process.size（注意不是 Flink 总内存）的比例，默认值 0.1。若根据此比例算出的内存量比最小值小或比最大值大，就会限制到最小值或者最大值。


## 内存参数设置 

Flink使用的内存分为堆上内存和堆外内存。
详细使用的参数直接参考官网，如下：
| 内存部分 |配置参数  | 描述  | 默认值  |
| --- | --- | --- | --- | 
| 框架堆内存（Framework Heap Memory） | taskmanager.memory.framework.heap.size|用于 Flink 框架的 JVM 堆内存（进阶配置）|默认128M，不建议修改| 
|任务堆内存（Task Heap Memory）|taskmanager.memory.task.heap.size| 用于 Flink 应用的算子及用户代码的 JVM 堆内存。 | 无默认值。不建议配置，Flink框架会使用Flink总内存-堆内框架内存-网络内存-托管内存得出。(按照默认值，肯定低于Flink总内存的50%) | 
|托管内存（Managed memory）|taskmanager.memory.managed.size 和taskmanager.memory.managed.fraction  |由 Flink 管理的用于排序、哈希表、缓存中间结果(批计算)以及 RocksDB State Backend 的本地内存(流计算)。受限Flink 总内存|无默认值，比例默认为0.4  | 
|框架堆外内存（Framework Off-heap Memory）  |taskmanager.memory.framework.off-heap.size  |用于 Flink 框架的堆外内存（直接内存或本地内存）（进阶配置）。|默认128M，不建议修改|
|任务堆外内存（Task Off-heap Memory） |taskmanager.memory.task.off-heap.size |用于 Flink 应用的算计及用户代码的堆外内存（直接内存或本地内存）。|默认是0|
|网络内存（Network Memory）|taskmanager.memory.network.min、taskmanager.memory.network.max、taskmanager.memory.network.fraction|用于任务之间数据传输的直接内存（例如网络传输缓冲）。该内存部分为基于 Flink 总内存的受限的等比内存部分。|最小是64M,最大是1G,比例是0.1，最终计算出来的值会限制在64M~1G|
|JVM Metaspace |taskmanager.memory.jvm-metaspace.size|Flink JVM 进程的 Metaspace。|默认256M|
|JVM 开销|taskmanager.memory.jvm-overhead.min、taskmanager.memory.jvm-overhead.max、taskmanager.memory.jvm-overhead.fraction|用于其他 JVM 开销的本地内存，例如栈空间、垃圾回收空间等。该内存部分为基于进程总内存的受限的等比内存部分。|最小192M、最大1G、比例是0.1 |


总体内存的配置：
1) Flink 使用内存
包括堆上内存和堆外内存(不包括JVM Metaspace和JVM 开销)，使用taskmanaer.memory.flink.size控制
2) Flink 进程使用内存
包括Flink使用内存 和 JVM使用的内存，使用参数taskmanager.memory.process.size控制

# Flink cpu 调优

## 并行度设置
目前主要是4种设置并行度方式：
1、算子
```java
final StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
DataStream<String> text = [...]
DataStream<Tuple2<String, Integer>> wordCounts = text
    .flatMap(new LineSplitter())
    .keyBy(0)
    .timeWindow(Time.seconds(5))
    .sum(1).setParallelism(5);
wordCounts.print();
env.execute("Word Count Example");
```

2、执行环境
在执行环境中可以给所有执行的算子、source、sink 设置默认并行度
```java
final StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
    env.setParallelism(3);
    DataStream<String> text = [...]
    DataStream<Tuple2<String, Integer>> wordCounts = [...]
    wordCounts.print();
    env.execute("Word Count Example");
```

3、客户端
在客户端提交 job 到 Flink 时设定。对于CLI客户端，可以通过“-p”参数指定并行度。例如：./bin/flink run -p 10 ../examples/WordCount-java.jar

4、系统配置
在系统中可以修改 Flink 客户端 conf 目录下的 flink-conf.yaml 文件中的 parallelism.default 配置选项来指定所有执行环境的默认并行度。

